name: Auto Publish

on:
  push:
    branches:
      - main
    paths:
      - 'extensions/**'
      - 'templates/**'
      - 'brands/**'
  workflow_dispatch:
    inputs:
      extension:
        description: 'Extension to publish (blank = all)'
        required: false
        type: string

permissions:
  id-token: write
  contents: read

env:
  AZURE_CLIENT_ID: "32a7f876-b319-4703-be8c-f45654b3ad13"
  AZURE_TENANT_ID: "38fcc012-5a88-4df9-b912-44ad0ee73268"
  AZURE_SUBSCRIPTION_ID: "42fa28b4-93f8-496e-8093-53417e5be8bf"
  KEY_VAULT_NAME: "lucidhub-kv-dev"

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    outputs:
      extensions: ${{ steps.detect.outputs.extensions }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 2

    - name: Detect changed extensions
      id: detect
      run: |
        if [ -n "${{ inputs.extension }}" ]; then
          echo 'extensions=["${{ inputs.extension }}"]' >> $GITHUB_OUTPUT
          exit 0
        fi

        # Manual dispatch with no input: publish all extensions
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          EXTENSIONS=$(ls -d extensions/*/ | xargs -I{} basename {} | jq -R -s -c 'split("\n") | map(select(. != ""))')
          echo "extensions=$EXTENSIONS" >> $GITHUB_OUTPUT
          exit 0
        fi

        CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)

        # If templates or brands changed, publish all extensions
        if echo "$CHANGED_FILES" | grep -qE '^(templates/|brands/)'; then
          EXTENSIONS=$(ls -d extensions/*/ | xargs -I{} basename {} | jq -R -s -c 'split("\n") | map(select(. != ""))')
          echo "extensions=$EXTENSIONS" >> $GITHUB_OUTPUT
          exit 0
        fi

        # Otherwise, only publish extensions with changes
        EXTENSIONS=$(echo "$CHANGED_FILES" | grep '^extensions/' | cut -d/ -f2 | sort -u | jq -R -s -c 'split("\n") | map(select(. != ""))')
        if [ "$EXTENSIONS" = "[]" ] || [ -z "$EXTENSIONS" ]; then
          echo 'extensions=[]' >> $GITHUB_OUTPUT
        else
          echo "extensions=$EXTENSIONS" >> $GITHUB_OUTPUT
        fi

  publish:
    needs: detect-changes
    if: needs.detect-changes.outputs.extensions != '[]'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20'

    - name: Install vsce
      run: npm install -g @vscode/vsce

    - name: Azure Login (OIDC)
      uses: azure/login@v2
      with:
        client-id: ${{ env.AZURE_CLIENT_ID }}
        tenant-id: ${{ env.AZURE_TENANT_ID }}
        subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

    - name: Allow runner access to Key Vault
      id: firewall
      run: |
        RUNNER_IP=$(curl -s https://api.ipify.org)
        echo "runner_ip=$RUNNER_IP" >> $GITHUB_OUTPUT
        az keyvault network-rule add --name "${{ env.KEY_VAULT_NAME }}" --ip-address "$RUNNER_IP/32" --only-show-errors
        sleep 10

    - name: Get VSCE PAT from Key Vault
      id: keyvault
      run: |
        VSCE_PAT=$(az keyvault secret show --vault-name "${{ env.KEY_VAULT_NAME }}" --name "vsce-marketplace-pat" --query "value" -o tsv)
        echo "::add-mask::$VSCE_PAT"
        echo "VSCE_PAT=$VSCE_PAT" >> "$GITHUB_ENV"

    - name: Remove runner access from Key Vault
      if: always()
      run: |
        az keyvault network-rule remove --name "${{ env.KEY_VAULT_NAME }}" --ip-address "${{ steps.firewall.outputs.runner_ip }}/32" --only-show-errors

    - name: Publish extensions
      run: |
        EXTENSIONS='${{ needs.detect-changes.outputs.extensions }}'
        FAILED=""
        SUCCEEDED=""

        for ext in $(echo "$EXTENSIONS" | jq -r '.[]'); do
          echo "::group::Publishing $ext"

          VERSION=$(node -p "require('./extensions/$ext/package.json').version")
          echo "Version: $VERSION"

          # Copy brand assets
          [ -f "brands/$ext/icon.png" ] && cp "brands/$ext/icon.png" "extensions/$ext/icon.png"
          [ -f "brands/$ext/README.md" ] && cp "brands/$ext/README.md" "extensions/$ext/README.md"

          # Package
          (cd "extensions/$ext" && vsce package)

          # Publish with retry
          PUBLISHED=false
          for attempt in 1 2 3; do
            echo "Attempt $attempt of 3..."
            if (cd "extensions/$ext" && vsce publish -p "$VSCE_PAT"); then
              echo "$ext v$VERSION published successfully!"
              SUCCEEDED="$SUCCEEDED $ext"
              PUBLISHED=true
              break
            fi
            if [ $attempt -lt 3 ]; then
              echo "Retrying in 30s..."
              sleep 30
            fi
          done

          if [ "$PUBLISHED" = "false" ]; then
            echo "::error::Failed to publish $ext after 3 attempts"
            FAILED="$FAILED $ext"
          fi

          echo "::endgroup::"

          # Brief pause between extensions to avoid rate limits
          sleep 5
        done

        echo ""
        echo "=== Summary ==="
        [ -n "$SUCCEEDED" ] && echo "Succeeded:$SUCCEEDED"
        [ -n "$FAILED" ] && echo "Failed:$FAILED"
        [ -n "$FAILED" ] && exit 1
        echo "All extensions published successfully!"
